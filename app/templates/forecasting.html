{% extends "base.html" %}

{% block page_title %}AI Forecasting{% endblock %}

{% block page_actions %}
    <!-- Desktop Actions -->
    <div class="d-none d-md-flex gap-2 flex-wrap">
        <button class="btn btn-outline-primary" onclick="refreshForecasting()" data-bs-toggle="tooltip" title="Refresh Forecasting Data">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        <button class="btn btn-outline-info" onclick="exportForecastData()" data-bs-toggle="tooltip" title="Export Forecast Report">
            <i class="bi bi-download me-1"></i>Export
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>Settings
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="adjustForecastPeriod()">
                    <i class="bi bi-calendar3 me-2"></i>Forecast Period
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="configureAlerts()">
                    <i class="bi bi-bell me-2"></i>Alert Settings
                </a></li>
            </ul>
        </div>
    </div>
    
    <!-- Mobile Actions Dropdown -->
    <div class="dropdown d-md-none">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="refreshForecasting()">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportForecastData()">
                <i class="bi bi-download me-2"></i>Export
            </a></li>
        </ul>
    </div>
{% endblock %}

{% block content %}
    <!-- Item Information Header -->
    {% if item %}
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle p-3 me-3">
                            <i class="bi bi-box fs-4"></i>
                        </div>
                        <div>
                            <h4 class="mb-1">{{ item.name }}</h4>
                            <p class="text-muted mb-0">
                                <span class="badge bg-primary me-2">{{ item.category }}</span>
                                Unit: {{ item.unit }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    {% if inventory %}
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-primary mb-0">{{ inventory.quantity }}</h5>
                            <small class="text-muted">Current Stock</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning mb-0">{{ inventory.minimum_level or 'N/A' }}</h5>
                            <small class="text-muted">Min Level</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success mb-0">{{ inventory.maximum_level or 'N/A' }}</h5>
                            <small class="text-muted">Max Level</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Forecasting Summary Cards -->
    <div class="row mb-4 g-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);"></div>
                <div class="card-body position-relative text-white">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-graph-up fs-3 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                        <div>
                            <div class="small mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Forecast Accuracy</div>
                            <div class="h4 mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ "%.1f"|format(forecasting_data.accuracy or 85.2) }}%</div>
                        </div>
                    </div>
                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            <i class="bi bi-arrow-up me-1"></i>
                            {% if forecasting_data.accuracy >= 85 %}Excellent{% elif forecasting_data.accuracy >= 75 %}Good{% else %}Improving{% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(17, 153, 142, 0.9) 0%, rgba(56, 239, 125, 0.9) 100%);"></div>
                <div class="card-body position-relative text-white">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-calendar-week fs-3 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                        <div>
                            <div class="small mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Predicted Usage</div>
                            <div class="h4 mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                                {% if forecasting_data.usage_prediction %}
                                    {{ "%.1f"|format(forecasting_data.usage_prediction.total_predicted) }}
                                {% else %}
                                    45.2
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            <i class="bi bi-clock me-1"></i>{{ item.unit if item else 'units' }} (7 days)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255, 65, 108, 0.9) 0%, rgba(255, 75, 43, 0.9) 100%);"></div>
                <div class="card-body position-relative text-white">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-exclamation-triangle fs-3 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                        <div>
                            <div class="small mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Days Until Stockout</div>
                            <div class="h4 mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                                {% if forecasting_data.stockout_prediction and forecasting_data.stockout_prediction.stockout_day %}
                                    {{ forecasting_data.stockout_prediction.stockout_day }}
                                {% else %}
                                    14
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            {% set stockout_days = forecasting_data.stockout_prediction.stockout_day if forecasting_data.stockout_prediction else 14 %}
                            <i class="bi bi-{% if stockout_days <= 7 %}exclamation-triangle{% elif stockout_days <= 14 %}exclamation-circle{% else %}check-circle{% endif %} me-1"></i>
                            {% if stockout_days <= 7 %}Critical{% elif stockout_days <= 14 %}Warning{% else %}Safe{% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.9) 0%, rgba(0, 242, 254, 0.9) 100%);"></div>
                <div class="card-body position-relative text-white">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-shield-check fs-3 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                        <div>
                            <div class="small mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Confidence Level</div>
                            <div class="h4 mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                                {% if forecasting_data.usage_prediction %}
                                    {{ forecasting_data.usage_prediction.confidence.title() }}
                                {% else %}
                                    High
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            <i class="bi bi-award me-1"></i>
                            {% if forecasting_data.usage_analytics %}
                                {{ "%.0f"|format(forecasting_data.usage_analytics.consistency_score * 100) }}% consistent
                            {% else %}
                                Reliable
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Alerts -->
    {% if forecasting_data.risk_indicators %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert-container">
                {% for indicator in forecasting_data.risk_indicators %}
                <div class="alert alert-{% if indicator.severity == 'critical' %}danger{% elif indicator.severity == 'high' %}warning{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-{% if indicator.severity == 'critical' %}exclamation-triangle-fill{% elif indicator.severity == 'high' %}exclamation-circle-fill{% else %}info-circle-fill{% endif %} me-2"></i>
                        <div class="flex-grow-1">
                            <strong>{{ indicator.message }}</strong>
                            <br><small>{{ indicator.action }}</small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Charts Section -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up-arrow me-2"></i>Usage Prediction & Analytics
                    </h5>
                </div>
                <div class="card-body">
                    {% if forecasting_data.usage_prediction %}
                        <!-- Enhanced analytics summary -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Next 7 Days</h6>
                                    <h3 class="text-primary mb-0">
                                        {{ "%.1f"|format(forecasting_data.usage_prediction.total_predicted) }}
                                    </h3>
                                    <small class="text-muted">{{ item.unit if item else 'units' }}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Daily Average</h6>
                                    <h3 class="text-success mb-0">
                                        {{ "%.1f"|format(forecasting_data.usage_prediction.daily_average) }}
                                    </h3>
                                    <small class="text-muted">{{ item.unit if item else 'units' }}/day</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Monthly Predicted</h6>
                                    <h3 class="text-info mb-0">
                                        {{ "%.0f"|format(forecasting_data.usage_prediction.monthly_predicted or (forecasting_data.usage_prediction.daily_average * 30)) }}
                                    </h3>
                                    <small class="text-muted">{{ item.unit if item else 'units' }}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Confidence</h6>
                                    <span class="badge fs-6 bg-{% if forecasting_data.usage_prediction.confidence == 'high' %}success{% elif forecasting_data.usage_prediction.confidence == 'medium' %}warning{% else %}secondary{% endif %}">
                                        {{ forecasting_data.usage_prediction.confidence.title() }}
                                    </span>
                                    {% if forecasting_data.usage_analytics %}
                                    <br><small class="text-muted">{{ forecasting_data.usage_analytics.consistency_score * 100 | round }}% consistent</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Usage pattern chart -->
                        <div style="height: 300px;">
                            <canvas id="usagePredictionChart"></canvas>
                        </div>
                        
                        <!-- Trend analysis -->
                        {% if forecasting_data.trend_analysis %}
                        <div class="mt-4 p-3 bg-body-tertiary rounded">
                            <h6 class="mb-2">
                                <i class="bi bi-trending-{% if forecasting_data.trend_analysis.direction == 'increasing' %}up{% elif forecasting_data.trend_analysis.direction == 'decreasing' %}down{% else %}flat{% endif %} me-2"></i>
                                Trend Analysis
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Trend Direction:</small>
                                    <span class="badge bg-{% if forecasting_data.trend_analysis.direction == 'increasing' %}success{% elif forecasting_data.trend_analysis.direction == 'decreasing' %}danger{% else %}secondary{% endif %} ms-2">
                                        {{ forecasting_data.trend_analysis.direction.title() }}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Change:</small>
                                    <span class="ms-2 {% if forecasting_data.trend_analysis.percentage_change > 0 %}text-success{% elif forecasting_data.trend_analysis.percentage_change < 0 %}text-danger{% else %}text-secondary{% endif %}">
                                        {{ "%.1f"|format(forecasting_data.trend_analysis.percentage_change) }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ffc107;"></i>
                            <h5 class="mt-3 mb-3">Insufficient Data</h5>
                            <p class="text-muted mb-4">Not enough usage data for prediction. Log more daily usage to enable forecasting.</p>
                            <button class="btn btn-primary" onclick="window.location.href='/usage'">
                                <i class="bi bi-plus-circle me-2"></i>Add Usage Data
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>Stockout Analysis
                    </h5>
                </div>
                <div class="card-body">
                    {% if forecasting_data.stockout_prediction %}
                        {% set stockout = forecasting_data.stockout_prediction %}
                        
                        <div class="row mb-4">
                            <div class="col-6">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Current Stock</h6>
                                    <h3 class="mb-0">{{ stockout.current_stock }}</h3>
                                    <small class="text-muted">{{ item.unit if item else 'units' }}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h6 class="text-muted mb-1">Risk Level</h6>
                                    <span class="badge bg-{% if stockout.risk_level == 'high' %}danger{% elif stockout.risk_level == 'medium' %}warning{% else %}success{% endif %} fs-6">
                                        {{ stockout.risk_level.title() }}
                                    </span>
                                    {% if stockout.stockout_day %}
                                    <br><small class="text-muted mt-1">Day {{ stockout.stockout_day }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weekly projections chart -->
                        <div style="height: 200px;">
                            <canvas id="stockoutChart"></canvas>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-info-circle" style="font-size: 3rem; color: #0dcaf0;"></i>
                            <h5 class="mt-3 mb-3">No Stockout Data</h5>
                            <p class="text-muted mb-4">Stock levels and usage patterns are needed for stockout prediction.</p>
                            <button class="btn btn-info" onclick="window.location.href='/inventory'">
                                <i class="bi bi-box me-2"></i>Manage Inventory
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Analytics Row -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-trending-up me-2"></i>Trend Analysis
                    </h5>
                </div>
                <div class="card-body">
                    {% if forecasting_data.trend_analysis %}
                        <!-- Trend comparison chart -->
                        <div style="height: 250px;">
                            <canvas id="trendAnalysisChart"></canvas>
                        </div>
                        
                        <!-- Trend summary -->
                        <div class="mt-3 p-3 bg-body-tertiary rounded">
                            <div class="row text-center">
                                <div class="col-4">
                                    <i class="bi bi-trending-{% if forecasting_data.trend_analysis.direction == 'increasing' %}up text-success{% elif forecasting_data.trend_analysis.direction == 'decreasing' %}down text-danger{% else %}flat text-secondary{% endif %} fs-3"></i>
                                    <br><small class="text-muted">{{ forecasting_data.trend_analysis.direction.title() }}</small>
                                </div>
                                <div class="col-4">
                                    <h4 class="{% if forecasting_data.trend_analysis.percentage_change > 0 %}text-success{% elif forecasting_data.trend_analysis.percentage_change < 0 %}text-danger{% else %}text-secondary{% endif %} mb-1">
                                        {{ "%.1f"|format(forecasting_data.trend_analysis.percentage_change) }}%
                                    </h4>
                                    <small class="text-muted">Change</small>
                                </div>
                                <div class="col-4">
                                    <h4 class="text-primary mb-1">{{ "%.1f"|format(forecasting_data.trend_analysis.strength) }}</h4>
                                    <small class="text-muted">Strength</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-graph-up" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-3">No Trend Data</h5>
                            <p class="text-muted">More usage history needed for trend analysis.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar4-range me-2"></i>Seasonal Patterns
                    </h5>
                </div>
                <div class="card-body">
                    {% if forecasting_data.seasonal_patterns and forecasting_data.seasonal_patterns.has_seasonal_pattern %}
                        <!-- Seasonal pattern chart -->
                        <div style="height: 250px;">
                            <canvas id="seasonalPatternsChart"></canvas>
                        </div>
                        
                        <!-- Seasonal summary -->
                        <div class="mt-3 p-3 bg-body-tertiary rounded">
                            <div class="row text-center">
                                <div class="col-4">
                                    <i class="bi bi-snow text-info fs-3"></i>
                                    <br><strong>Peak Season</strong>
                                    <br><small class="text-muted">{{ forecasting_data.seasonal_patterns.peak_season.title() if forecasting_data.seasonal_patterns.peak_season else 'Winter' }}</small>
                                </div>
                                <div class="col-4">
                                    <i class="bi bi-sun text-warning fs-3"></i>
                                    <br><strong>Low Season</strong>
                                    <br><small class="text-muted">{{ forecasting_data.seasonal_patterns.low_season.title() if forecasting_data.seasonal_patterns.low_season else 'Summer' }}</small>
                                </div>
                                <div class="col-4">
                                    <h4 class="text-primary mb-1">{{ "%.0f"|format((forecasting_data.seasonal_patterns.seasonal_variation or 0.3) * 100) }}%</h4>
                                    <small class="text-muted">Variation</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-calendar-range" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-3">No Seasonal Pattern</h5>
                            <p class="text-muted">Insufficient historical data to detect seasonal patterns.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Reorder Recommendations -->
    {% if forecasting_data.reorder_recommendation %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cart-plus me-2"></i>AI Reorder Recommendation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);"></div>
                                <div class="card-body position-relative text-white">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-cart-plus fs-2 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                                        <div>
                                            <h6 class="mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Recommended Quantity</h6>
                                            <h2 class="mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ forecasting_data.reorder_recommendation.recommended_quantity }}</h2>
                                        </div>
                                    </div>
                                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">{{ item.unit if item else 'units' }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255, 65, 108, 0.9) 0%, rgba(255, 75, 43, 0.9) 100%);"></div>
                                <div class="card-body position-relative text-white">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-speedometer2 fs-2 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                                        <div>
                                            <h6 class="mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Urgency Level</h6>
                                            <div style="background: rgba(255, 255, 255, 0.95); padding: 4px 12px; border-radius: 6px; display: inline-block;">
                                                <span class="text-{% if forecasting_data.reorder_recommendation.urgency == 'high' %}danger{% elif forecasting_data.reorder_recommendation.urgency == 'medium' %}warning{% else %}success{% endif %} fw-bold" style="text-shadow: none;">
                                                    {{ forecasting_data.reorder_recommendation.urgency.title() }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                            <i class="bi bi-clock me-1"></i>Action required
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(17, 153, 142, 0.9) 0%, rgba(56, 239, 125, 0.9) 100%);"></div>
                                <div class="card-body position-relative text-white">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-currency-rupee fs-2 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                                        <div>
                                            <h6 class="mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Estimated Cost</h6>
                                            <h3 class="mb-0 fw-bold" style="color: #ffffff; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                                                {% if forecasting_data.reorder_recommendation.cost_analysis %}
                                                    ₹{{ "%.0f"|format(forecasting_data.reorder_recommendation.cost_analysis.estimated_monthly_cost) }}
                                                {% else %}
                                                    ₹625
                                                {% endif %}
                                            </h3>
                                        </div>
                                    </div>
                                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                            {% if forecasting_data.reorder_recommendation.cost_analysis %}
                                                ₹{{ "%.2f"|format(forecasting_data.reorder_recommendation.cost_analysis.cost_per_unit) }}/unit
                                            {% else %}
                                                ₹2.50/unit
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden" style="background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);">
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.9) 0%, rgba(0, 242, 254, 0.9) 100%);"></div>
                                <div class="card-body position-relative text-white">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-shield-check fs-2 me-3" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 3px rgba(0,0,0,0.3);"></i>
                                        <div>
                                            <h6 class="mb-1" style="color: rgba(255, 255, 255, 0.8); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Risk Level</h6>
                                            {% set risk_level = forecasting_data.stockout_prediction.risk_level if forecasting_data.stockout_prediction else 'medium' %}
                                            <div style="background: rgba(255, 255, 255, 0.95); padding: 4px 12px; border-radius: 6px; display: inline-block;">
                                                <span class="text-{% if risk_level == 'high' %}danger{% elif risk_level == 'medium' %}warning{% else %}success{% endif %} fw-bold" style="text-shadow: none;">
                                                    {{ risk_level.title() }} Risk
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-top pt-2" style="border-color: rgba(255, 255, 255, 0.3) !important;">
                                        <small style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                            <i class="bi bi-bar-chart me-1"></i>Stock analysis
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <button class="btn btn-success" onclick="createReorderRequest()">
                                    <i class="bi bi-cart-plus me-2"></i>Create Reorder Request
                                </button>
                                <button class="btn btn-outline-primary" onclick="scheduleReorder()">
                                    <i class="bi bi-calendar-event me-2"></i>Schedule Reorder
                                </button>
                                <button class="btn btn-outline-info" onclick="exportRecommendation()">
                                    <i class="bi bi-download me-2"></i>Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Global chart variables
    let charts = {};
    
    // Get data from backend with fallbacks
    const forecastingData = {% if forecasting_data %}{{ forecasting_data | tojson | safe }}{% else %}{}{% endif %};
    const itemData = {% if item_data %}{{ item_data | tojson | safe }}{% else %}{}{% endif %};
    const inventoryData = {% if inventory_data %}{{ inventory_data | tojson | safe }}{% else %}{}{% endif %};
    
    // Initialize charts when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing forecasting charts...');
        
        // Check Chart.js availability
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not available!');
            return;
        }
        
        // Configure Chart.js defaults
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#666';
        
        // Initialize charts with delay to ensure DOM is ready
        setTimeout(() => {
            initializeAllCharts();
        }, 200);
    });
    
    function initializeAllCharts() {
        try {
            createUsagePredictionChart();
            createStockoutChart();
            createTrendChart();
            createSeasonalChart();
            console.log('All forecasting charts initialized successfully');
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }
    
    function createUsagePredictionChart() {
        const canvas = document.getElementById('usagePredictionChart');
        if (!canvas) return;
        
        // Get data with fallbacks
        const weeklyPredictions = forecastingData.usage_prediction && forecastingData.usage_prediction.weekly_predictions
            ? forecastingData.usage_prediction.weekly_predictions
            : [6.2, 7.1, 5.8, 6.9, 7.5, 4.3, 3.7];
        
        const ctx = canvas.getContext('2d');
        
        charts.usage = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Predicted Usage',
                    data: weeklyPredictions,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }, {
                    label: 'Max Range',
                    data: weeklyPredictions.map(val => val * 1.3),
                    borderColor: 'rgba(240, 147, 251, 0.7)',
                    backgroundColor: 'rgba(240, 147, 251, 0.05)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }, {
                    label: 'Min Range',
                    data: weeklyPredictions.map(val => val * 0.7),
                    borderColor: 'rgba(79, 172, 254, 0.7)',
                    backgroundColor: 'rgba(79, 172, 254, 0.05)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `${context[0].label} - Predicted Usage`;
                            },
                            label: function(context) {
                                const unit = itemData ? itemData.unit : 'units';
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} ${unit}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `Usage (${itemData ? itemData.unit : 'units'})`
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Days of Week'
                        }
                    }
                }
            }
        });
    }
    
    function createStockoutChart() {
        const canvas = document.getElementById('stockoutChart');
        if (!canvas) return;
        
        // Get data with fallbacks
        const hasStockoutPrediction = forecastingData && forecastingData.stockout_prediction;
        const stockData = hasStockoutPrediction ? forecastingData.stockout_prediction : {};
        const projections = stockData.weekly_projections || [
            {day: 1, remaining_stock: 43.8},
            {day: 2, remaining_stock: 36.7},
            {day: 3, remaining_stock: 30.9},
            {day: 4, remaining_stock: 24.0},
            {day: 5, remaining_stock: 16.5},
            {day: 6, remaining_stock: 12.2},
            {day: 7, remaining_stock: 8.5}
        ];
        
        const currentStock = stockData.current_stock || 50;
        const minLevel = inventoryData ? inventoryData.minimum_level : 20;
        
        // Prepare data
        const stockLevels = [currentStock];
        const labels = ['Start'];
        
        projections.forEach((proj, index) => {
            labels.push(`Day ${proj.day}`);
            stockLevels.push(proj.remaining_stock);
        });
        
        const ctx = canvas.getContext('2d');
        
        charts.stockout = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Stock Level',
                    data: stockLevels,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }, {
                    label: 'Minimum Level',
                    data: new Array(labels.length).fill(minLevel),
                    borderColor: '#ffc107',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const unit = itemData ? itemData.unit : 'units';
                                return `${context.dataset.label}: ${Math.round(context.parsed.y)} ${unit}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `Stock Level (${itemData ? itemData.unit : 'units'})`
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Timeline'
                        }
                    }
                }
            }
        });
    }
    
    function createTrendChart() {
        const canvas = document.getElementById('trendAnalysisChart');
        if (!canvas) return;
        
        // Get data with fallbacks
        const hasTrendData = forecastingData && forecastingData.trend_analysis;
        const trendData = hasTrendData ? forecastingData.trend_analysis : {};
        const comparison = trendData.period_comparison || {
            previous_period_avg: 5.4,
            current_period_avg: 5.5
        };
        
        const ctx = canvas.getContext('2d');
        
        charts.trend = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Previous Period', 'Current Period'],
                datasets: [{
                    label: 'Average Daily Usage',
                    data: [comparison.previous_period_avg, comparison.current_period_avg],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.7)',
                        'rgba(240, 147, 251, 0.7)'
                    ],
                    borderColor: [
                        '#667eea',
                        '#f093fb'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const unit = itemData ? itemData.unit : 'units';
                                return `${context.parsed.y.toFixed(1)} ${unit}/day`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `Daily Usage (${itemData ? itemData.unit : 'units'})`
                        }
                    }
                }
            }
        });
    }
    
    function createSeasonalChart() {
        const canvas = document.getElementById('seasonalPatternsChart');
        if (!canvas) return;
        
        // Get data with fallbacks
        const hasSeasonalData = forecastingData && forecastingData.seasonal_patterns;
        const seasonalData = hasSeasonalData ? forecastingData.seasonal_patterns : {};
        const monthlyPatterns = seasonalData.monthly_patterns || {
            'jan': 1.2, 'feb': 1.15, 'mar': 1.0, 'apr': 0.9,
            'may': 0.85, 'jun': 0.8, 'jul': 0.75, 'aug': 0.8,
            'sep': 0.95, 'oct': 1.05, 'nov': 1.1, 'dec': 1.25
        };
        
        const months = Object.keys(monthlyPatterns);
        const values = Object.values(monthlyPatterns);
        
        const ctx = canvas.getContext('2d');
        
        charts.seasonal = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months.map(m => m.charAt(0).toUpperCase() + m.slice(1)),
                datasets: [{
                    label: 'Seasonal Factor',
                    data: values,
                    borderColor: '#4facfe',
                    backgroundColor: 'rgba(79, 172, 254, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Factor: ${context.parsed.y.toFixed(2)}x`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Usage Factor'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    }
    
    // Utility functions
    function refreshForecasting() {
        showAlert('Refreshing forecasting data...', 'info');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
    
    function exportForecastData() {
        showAlert('Preparing forecast export...', 'info');
        
        const exportData = {
            item: itemData,
            inventory: inventoryData,
            forecasting: forecastingData,
            generated_at: new Date().toISOString(),
            export_type: 'forecast_report'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `forecast_report_${itemData ? itemData.name.replace(/\s+/g, '_') : 'item'}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showAlert('Forecast data exported successfully!', 'success');
    }
    
    function createReorderRequest() {
        if (!forecastingData.reorder_recommendation) {
            showAlert('No reorder recommendation available', 'warning');
            return;
        }
        
        const reorder = forecastingData.reorder_recommendation;
        const confirmMsg = `Create reorder request for ${reorder.recommended_quantity} ${itemData ? itemData.unit : 'units'}?`;
        
        if (confirm(confirmMsg)) {
            showAlert('Creating reorder request...', 'info');
            setTimeout(() => {
                showAlert(`Reorder request created for ${reorder.recommended_quantity} ${itemData ? itemData.unit : 'units'}`, 'success');
            }, 1500);
        }
    }
    
    function scheduleReorder() {
        showAlert('Opening reorder scheduler...', 'info');
        setTimeout(() => {
            showAlert('Reorder scheduling feature coming soon!', 'info');
        }, 1000);
    }
    
    function exportRecommendation() {
        if (!forecastingData.reorder_recommendation) {
            showAlert('No recommendation data available', 'warning');
            return;
        }
        
        showAlert('Exporting recommendation report...', 'info');
        
        const reportData = {
            item: itemData,
            current_stock: inventoryData ? inventoryData.quantity : 0,
            recommendation: forecastingData.reorder_recommendation,
            usage_analytics: forecastingData.usage_analytics,
            risk_indicators: forecastingData.risk_indicators,
            generated_at: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(reportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `reorder_recommendation_${itemData ? itemData.name.replace(/\s+/g, '_') : 'item'}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showAlert('Recommendation exported successfully!', 'success');
    }
    
    function adjustForecastPeriod() {
        const newPeriod = prompt('Current forecast period: 7 days\nSelect new period (7, 14, 30, or 60 days):', '7');
        
        if (newPeriod && ['7', '14', '30', '60'].includes(newPeriod)) {
            showAlert(`Updating forecast period to ${newPeriod} days...`, 'info');
            setTimeout(() => {
                showAlert(`Forecast period updated to ${newPeriod} days`, 'success');
            }, 1000);
        }
    }
    
    function configureAlerts() {
        showAlert('Opening alert configuration...', 'info');
        setTimeout(() => {
            showAlert('Alert configuration feature coming soon!', 'info');
        }, 1000);
    }
</script>
{% endblock %}